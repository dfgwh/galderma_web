<!DOCTYPE html>
<html lang = "en">
    <head>
        <title>galderma</title>

		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
        <link type="text/css" rel="stylesheet" href="main.css">
        
        <style>
			a {
				color: #f00;
			}
			.no-pointer-events {
				pointer-events: none;
			}
			.control-disabled {
				color: #888;
				text-decoration: line-through;
			}
		</style>
    </head>
    <body>
		<script src = "three.js"></script>
        <script src = "js/main.js"></script>

		<div class = "container">
			<div id = "openPackageButton" type = "button">
				<div class = "blockInButton">
					<img src="images/open_icon.svg">
					<span>Open Package</span>
				</div>
			</div>
			<div id = "backButton" type = "button">
				<div class = "blockInButton">
					<img src="images/Vector4.svg">
					<span>Back</span>
				</div>
			</div>
			<div id = "prepareButton" type = "button">
				<div class = "blockInButton">
					<img src="images/prepare_icon.png">
					<span>Prepare</span>
				</div>
			</div>
		</div>

		<script type = "module">

			import { OrbitControls } from './three/examples/jsm/controls/OrbitControls.js';
        	import { FBXLoader } from './three/examples/jsm/loaders/FBXLoader.js';
			//import { GLTFLoader } from './three/examples/jsm/loaders/GLTFLoader.js';
			import { TWEEN } from './three/examples/jsm/libs/tween.module.min.js';
			import { Reflector } from './three/examples/jsm/objects/Reflector.js';
			import { CSS2DRenderer, CSS2DObject } from './three/examples/jsm/renderers/CSS2DRenderer.js';
			import { Refractor } from './three/examples/jsm/objects/Refractor.js';
			import { WaterRefractionShader } from './three/examples/jsm/shaders/WaterRefractionShader.js';
			//import { BokehShader, BokehDepthShader } from './three/examples/jsm/shaders/BokehShader2.js';

			// scene field

            let scene, renderer, camera, orbitcontrol;
			let refractor;

			// model field

			let model, mainmodel, ingectionSyringeModel, needle1Model, 
				needle2Model, box, form, manual, formcup, 
				plangerCap, needleCase, needleCap;
			const cubeRenderTarget = new THREE.WebGLCubeRenderTarget(2048)
			const cubeCamera = new THREE.CubeCamera(0.1, 100, cubeRenderTarget)
			const glassMaterial = new THREE.MeshPhysicalMaterial({
				metalness: 1.0,
				roughness: 0.2,
				envMap: cubeRenderTarget.texture,
				refractionRatio: 0.95,
				transparent: true,
				opacity: 0.4,
				transmission: 0.1,
				side: THREE.FrontSide,
				clearcoat: 1.0,
				clearcoatRoughness: 0.39
			});

			const formMaterial = new THREE.MeshPhysicalMaterial({
				metalness: 1.0,
				roughness: 0.2,
				envMap: cubeRenderTarget.texture,
				refractionRatio: 0.95,
				transparent: true,
				opacity: 0.2,
				transmission: 0.1,
				side: THREE.FrontSide,
				clearcoat: 1.0,
				clearcoatRoughness: 0.39
			});

			// animation field

			let skeleton, mixer, clock;
			let box_action, manual_action, setinjector_action, setneedle1_action, 
				setneedle2_action, prepareinjector_action, prepareneedle_action;
			let isOpenPackageAnimate = false, isBoxAnimate = false, isManualAnimate = false, 
				isPrepareNeedleAnimate = false, isPrepareInjectorAnimate = false, isPrepareAnimate = false,
				isOpenMainModel = false, isAnimate = false;
			let timer_delta;
			let isTime = false;
			let tempTime;
			let timedelta = 0;
			let isRebase = false;


			// app field

			const container = document.querySelector( '.container' );
			let width = window.innerWidth;
			let height = window.innerHeight;
			var mesh = [];
			let stepindeex = 0;



			init();
			


			function init() {
				createScene();
				
				scene.add(cubeCamera)



				const fbxLoader = new FBXLoader()
				model = fbxLoader.load(
					'models/Restlane1.fbx',
					(root) => {
						root.scale.set(60, 60, 60)
						scene.add(root);
						console.log(dumpObject(root).join('\n'));
						mainmodel = root;

						skeleton = new THREE.SkeletonHelper( root );
						skeleton.visible = false;
						scene.add( skeleton );

						const clips = root.animations;
						mixer = new THREE.AnimationMixer( root );
						console.log(clips);


						let scene_action = mixer.clipAction(clips[0]);
						scene_action.play();

						root.traverse(function(child){
							mesh.push(child);
							//console.log(child.name, "    ", child.animations);
							if (child.name == "Box" && !box /*|| child.name == "Form"*/)
							{
								box = child;
								//box.visible = false;
								//box = null;
							}

							if (child.name == "Injector_t")
							{
								ingectionSyringeModel = child;
							}
							if (child.name == "Needle2_t")
							{
								needle2Model = child;
							}
							if (child.name == "Needle_t")
							{
								needle1Model = child;
							}

                        	if (child.isMesh){

								if (child.name == "Form")
								{
									form = child;
									child.material = formMaterial;
									//child.visible = false;
								}
								if (child.name == "manual")
								{
									manual = child;
								}

								if (child.name == "FormCap")
								{
									formcup = child;
								}
								if (child.name == "plungerCap")
								{
									plangerCap = child;
								}
								
								if (child.name == "NeedleCase")
								{
									needleCase = child;
								}

								if (child.name == "NeedleCap")
								{
									needleCap = child;
								}
                    
								if (child.name == "InjectorGlass" || child.name == "NeedleCap" || child.name == "NeedleCase" || child.name == "NeedleCase2Glass")
								{
									child.material = glassMaterial;

									const annotationDiv = document.createElement('div');
									annotationDiv.className = 'annotationLabel';
									annotationDiv.innerHTML = '25';
									const annotationLabel = new CSS2DObject(annotationDiv);
									annotationLabel.position.copy(child.position);
									root.add(annotationLabel);

										const annotationTextDiv = document.createElement('div');
										annotationTextDiv.className = 'annotationDescription';
										annotationTextDiv.innerHTML = 'child.userData.title';
	
											annotationTextDiv.innerHTML += '<p>' + 'test' + '</p>';
										
										annotationDiv.appendChild(annotationTextDiv);	
								}
							}
                    	});


						update();
					},
					(xhr) => {
						console.log((xhr.loaded / xhr.total) * 100 + '% loaded')
					},
					(error) => {
						console.log(error)
					}
				);

				window.addEventListener('resize', onWindowResize, false)
				
				function onWindowResize() {
					camera.aspect = window.innerWidth / window.innerHeight;
					camera.updateProjectionMatrix();

					renderer.setSize(window.innerWidth, window.innerHeight)
				}

				function update()
				{
					mixer.update(clock.getDelta());
					requestAnimationFrame(update)
				}

				function animate() {
					//model.rotation.y += 0.1;
					requestAnimationFrame(animate)
					orbitcontrol.update();
					TWEEN.update()
					renderer.render(scene, camera)
				}
				animate();

			}

			// created base configurations for scene
			function createScene()
			{
				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.position.set( 1, 4, - 3 );
				camera.lookAt( 0, 1, 0 );

				document.addEventListener('mousedown', onDocumentMouseDown, false);

				clock = new THREE.Clock();

				scene = new THREE.Scene();
				scene.background = new THREE.Color("rgb(133,202,237)");
				scene.fog = new THREE.Fog("rgb(133,202,237)", 20, 80 );

				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.shadowMap.enabled = true;
				container.appendChild( renderer.domElement );

				//OrbitControls
				orbitcontrol = new OrbitControls(camera, renderer.domElement);
				orbitcontrol.update();
				orbitcontrol.maxPolarAngle = Math.PI / 2.5;
				//orbitcontrol.minPolarAngle = Math.PI / 3;
				orbitcontrol.enablePan = false;
				orbitcontrol.dampingFactor = 0.1;
				orbitcontrol.enableDamping = true;
				orbitcontrol.minDistance = 20;
				orbitcontrol.maxDistance = 55;

				const hemiLight = new THREE.HemisphereLight( 0xffffff, 0x444444 );
				hemiLight.position.set( 0, 20, 0 );
				scene.add( hemiLight );
				const dirLight = new THREE.DirectionalLight( 0xffffff );
				dirLight.position.set( - 3, 10, - 10 );
				dirLight.castShadow = true;
				dirLight.shadow.camera.top = 2;
				dirLight.shadow.camera.bottom = - 2;
				dirLight.shadow.camera.left = - 2;
				dirLight.shadow.camera.right = 2;
				dirLight.shadow.camera.near = 0.1;
				dirLight.shadow.camera.far = 40;
				scene.add( dirLight );

				// ground
				const mesh = new THREE.Mesh( new THREE.PlaneGeometry( 2000, 2000 ), new THREE.MeshPhongMaterial( { color: 0x999999, depthWrite: false } ) );
				mesh.rotation.x = - Math.PI / 2;
				mesh.position.y = -20;
				mesh.receiveShadow = true;
				scene.add( mesh );

				const refractorGeometry = new THREE.PlaneGeometry( 2000, 2000 );

				refractor = new Refractor( refractorGeometry, {
					color: 0x999999,
					textureWidth: 100,
					textureHeight: 100,
					shader: WaterRefractionShader
				} );
				refractor.position.set( 0, 0, -1 );
				refractor.rotation.set(0, - Math.PI , 0);
				scene.add( refractor );
				refractor.visible = false;
			}

			// write object structer to console
			function dumpObject(obj, lines = [], isLast = true, prefix = '') {
					const localPrefix = isLast ? '└─' : '├─';
					lines.push(`${prefix}${prefix ? localPrefix : ''}${obj.name || '*no-name*'} [${obj.type}]`);
					const newPrefix = prefix + (isLast ? '  ' : '│ ');
					const lastNdx = obj.children.length - 1;
					obj.children.forEach((child, ndx) => {
						const isLast = ndx === lastNdx;
						dumpObject(child, lines, isLast, newPrefix);
					});
					return lines;
			}

			function startOpenPackageAnimation()
			{
				timer_delta = 6.6 + 1.6;

				box_action.reset()
				box_action.timeScale = 1;
				box_action.setLoop(THREE.LoopOnce);
				box_action.clampWhenFinished = true;

				manual_action.reset()
				manual_action.timeScale = 1;
				manual_action.setLoop(THREE.LoopOnce);
				manual_action.clampWhenFinished = true;

				setinjector_action.reset()
				setinjector_action.timeScale = 1;
				setinjector_action.setLoop(THREE.LoopOnce);
				setinjector_action.clampWhenFinished = true;

				setneedle1_action.reset()
				setneedle1_action.timeScale = 1;
				setneedle1_action.setLoop(THREE.LoopOnce);
				setneedle1_action.clampWhenFinished = true;

				setneedle2_action.reset()
				setneedle2_action.timeScale = 1;
				setneedle2_action.setLoop(THREE.LoopOnce);
				setneedle2_action.clampWhenFinished = true;

				box_action.play();
				isAnimate = true;
				isOpenPackageAnimate = true;
				isBoxAnimate = true;
			}
			
			function endOpenPackageAnimation()
			{
				startSecondStep();
			}

			function reversOpenPackageAnimation()
			{
				timer_delta = 6.6 + 1.6;
				box_action.paused = false;
				box_action.timeScale = -1;
				box_action.setLoop(THREE.LoopOnce);  

				manual_action.paused = false;
				manual_action.timeScale = -1;
				manual_action.setLoop(THREE.LoopOnce);  

				setinjector_action.paused = false;
				setinjector_action.timeScale = -1;
				setinjector_action.setLoop(THREE.LoopOnce);  

				setneedle1_action.paused = false;
				setneedle1_action.timeScale = -1;
				setneedle1_action.setLoop(THREE.LoopOnce);  

				setneedle2_action.paused = false;
				setneedle2_action.timeScale = -1;
				setneedle2_action.setLoop(THREE.LoopOnce);  

				isAnimate = true;
				isOpenPackageAnimate = true;
				isRebase = true;
				isBoxAnimate = false;

				manual.visible = false;
				formcup.visible = false;
				box.visible = false;
				form.visible = false;

				setinjector_action.play();
				setneedle1_action.play();
				setneedle2_action.play();
			}

			function startPrepareAnimation()
			{
				timer_delta = 2.499;

				prepareinjector_action.reset()
				prepareinjector_action.timeScale = 1;
				prepareinjector_action.setLoop(THREE.LoopOnce);
				prepareinjector_action.clampWhenFinished = true;
			
				prepareneedle_action.reset()
				prepareneedle_action.timeScale = 1;
				prepareneedle_action.setLoop(THREE.LoopOnce);
				prepareneedle_action.clampWhenFinished = true;

				prepareneedle_action.play();
				prepareinjector_action.play();

				needle2Model.visible = false;
				plangerCap.visible = false;
				needleCase.visible = false;
				needleCap.visible = false;

				isAnimate = true;
				isPrepareAnimate = true;
				isPrepareInjectorAnimate = true;
				isPrepareNeedleAnimate = true;

				document.getElementById("prepareButton").style.display = "none";
				document.getElementById("backButton").style.display = "none";
			}

			function reversPrepareAnimation()
			{
				timer_delta = 2.5;

				prepareinjector_action.paused = false;
				prepareinjector_action.timeScale = -1;
				prepareinjector_action.setLoop(THREE.LoopOnce);  

				prepareneedle_action.paused = false;
				prepareneedle_action.timeScale = -1;
				prepareneedle_action.setLoop(THREE.LoopOnce);  

				isAnimate = true;
				isPrepareAnimate = true;
				isPrepareInjectorAnimate = false;
				isPrepareNeedleAnimate = true;

				prepareneedle_action.play();

				document.getElementById("prepareButton").style.display = "none";
				document.getElementById("backButton").style.display = "none";
			}

			function endReversPrepareAnimation()
			{
				needle2Model.visible = true;
				plangerCap.visible = true;
				needleCase.visible = true;
				needleCap.visible = true;

				isRebase = false;

				startSecondStep();
			}

			function endPrepareAnimation()
			{
				document.getElementById("backButton").style.display = "block";
				stepindeex = 2;
			}

			function startSecondStep()
			{
				document.getElementById("backButton").style.display = "block";
				document.getElementById("prepareButton").style.display = "block";
				stepindeex = 1;
			}


			function resizeRendererToDisplaySize(renderer) {
				const canvas = renderer.domElement;
				const width = canvas.clientWidth;
				const height = canvas.clientHeight;
				const needResize = canvas.width !== width || canvas.height !== height;
				if (needResize) {
				renderer.setSize(width, height, false);
				}
				return needResize;
			}



			function render(time) {
				time *= 0.001;  // convert to seconds
				if (isAnimate && !isTime)
				{
					isTime = true;
					tempTime = time;
					console.log("start", time, " ", timer_delta);
				}

				if (isTime)
				{
					timedelta = (time) - tempTime;
				}
				//timedelta = (time)- tempTime;

				if (isAnimate&&isOpenPackageAnimate)
				{
					if (isRebase)
					{
						if (timedelta > 1.6 && !isBoxAnimate)
						{
							box.visible = true;
							manual.visible = true;
							isBoxAnimate = true;
							isManualAnimate = true;
							box_action.play();
							manual_action.play();
							console.log("start box and manual");
						}

						if (timedelta > 2.4 && isManualAnimate)
						{
							isManualAnimate = false;
							manual_action.stop();
							console.log("end of manual")
						}

						if (timedelta > timer_delta)
						{
							isAnimate = false;
							isTime = false;
							isOpenPackageAnimate = false;

							box_action.stop();
							manual_action.stop();

							isBoxAnimate = false;

							//endOpenPackageAnimation();
						}
					}
					else
					{
						if (timedelta > 4.2 && isBoxAnimate && !isManualAnimate)
						{
							manual_action.play();
							console.log("start manual");
							isManualAnimate = true;
						}
						if (timedelta > 6.6 && isBoxAnimate)
						{
							box_action.stop();
							manual_action.stop();
							console.log("end manual with box");
							isBoxAnimate = false;
							isManualAnimate = false;
							manual.visible = false;
							formcup.visible = false;
							box.visible = false;
							form.visible = false;

							setinjector_action.play();
							setneedle1_action.play();
							setneedle2_action.play();
						}

						if (timedelta > timer_delta)
						{
							isAnimate = false;
							isTime = false;
							isOpenPackageAnimate = false;

							setinjector_action.paused = true;
							setneedle1_action.paused = true;
							setneedle2_action.paused = true;

							isBoxAnimate = false;

							endOpenPackageAnimation();
						}
					}
				}

				if (isAnimate&&isPrepareAnimate)
				{
					//console.log(timedelta)
					if (isRebase)
					{
						if (timedelta > 0.89 && !isPrepareInjectorAnimate)
						{
							isPrepareInjectorAnimate = true;
							prepareinjector_action.play();
							console.log("start moov injectro")
						}
						if (timedelta > timer_delta)
						{
							isAnimate = false;
							isTime = false;
							isPrepareAnimate = false;
							isPrepareNeedleAnimate = false;

							prepareneedle_action.paused = true;
							prepareinjector_action.paused = true;
							//console.log("mmm");

							endReversPrepareAnimation();
						}
					}
					else{

						if (timedelta > 1.6 && isPrepareInjectorAnimate)
						{
							isPrepareInjectorAnimate = false;
							prepareinjector_action.paused = true;
							console.log("end moov injectro")
						}
						if (timedelta > timer_delta)
						{
							isAnimate = false;
							isTime = false;
							isPrepareAnimate = false;
							isPrepareNeedleAnimate = false;

							prepareneedle_action.paused = true;

							endPrepareAnimation();
						}
					}

				}

	
				renderer.render(scene, camera);
				
				requestAnimationFrame(render);
			}
			requestAnimationFrame(render);

			
			function InitUIClick()
			{
				let obj = document.getElementById("openPackageButton");
				let backButton = document.getElementById("backButton");
				let prepareButton = document.getElementById("prepareButton");

				obj.onclick = function(){
					isOpenMainModel = true;
					mainmodel.rotation.set(0,0,0);
					mainmodel.position.set(0,0,0);
					camera.position.set( 1, 1, - 3 );
					orbitcontrol.enabled = false;
					startOpenPackageAnimation();
					obj.style.display = "none";
					//backButton.style.display = "block";
				}

				backButton.onclick = function(){
					//isRebase = true;
					/*isOpenMainModel = false;
					mainmodel.rotation.set(0,0,0);
					mainmodel.position.set(0,0,0);
					camera.position.set( 1, 4, - 3 );
					orbitcontrol.enabled = true;
					//main_action.stop();
					mainmodel.visible = true;
					backButton.style.display = "none";
					obj.style.display = "block";
					ingectionSyringeModel.visible = false;
						needle1Model.visible = false;
						needle2Model.visible = false;
						requestAnimationFrame(render);*/
					//startReversManualActions();
					if (stepindeex == '2')
					{
						isRebase = true;
						reversPrepareAnimation();
					}
					if (stepindeex == '1')
					{
						isRebase = true;
						reversOpenPackageAnimation();
					}
				}
				prepareButton.onclick = function(){
					startPrepareAnimation();
				}


			}


	document.addEventListener('click', onDocumentMouseDown, false);
	
			function onDocumentMouseDown(event) {
				// Click on the screen to create a vector
				var vector = new THREE.Vector3((event.clientX / window.innerWidth) * 2 - 1, -(event.clientY / window
					.innerHeight) * 2 + 1, 0.5);
					vector = vector.unproject (camera); // convert the coordinates of the screen into the coordinate of the three-dimensional scene
				var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());
				var intersects = raycaster.intersectObjects(mesh, true);

				if (stepindeex)
				{
					if (intersects.length > 0) {
						//intersects[0].object.material.color.set("#ff0000");
						intersects.forEach(element => {
							//console.log(element.object.name);
							if (element.object.name == "Injector" ||
							element.object.name == "InjectorGlass" ||
							element.object.name == "plungerCap" ||
							element.object.name == "InjectorPlunger")
							{
								console.log("injector");
							}
							if (element.object.name == "Needle" ||
							element.object.name == "NeedleCase" ||
							element.object.name == "NeedleCap")
							{
								console.log("needle1");
							}
							if (element.object.name == "NeedleCase2" ||
							element.object.name == "NeedleCase2Glass")
							{
								console.log("needle2");
							}
						});
					}
				}	
			}

			InitUIClick();
			
        </script>
    </body>
</html>