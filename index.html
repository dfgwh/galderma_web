<!DOCTYPE html>
<html lang = "en">
    <head>
        <title>galderma</title>

		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
		
        <link type="text/css" rel="stylesheet" href="main.css">
        
        <style>
			a {
				color: #f00;
			}
			.no-pointer-events {
				pointer-events: none;
			}
			.control-disabled {
				color: #888;
				text-decoration: line-through;
			}
		</style>
    </head>
    <body>
		<script src = "three.js"></script>
        <script src = "js/main.js"></script>

		<div class = "container">
			<div id = "loaderPage">
				<img src="images/GALDERMA_LOGO.svg">
				<div id="progressBar" min="0" max="100"><div id="progress"></div></div>
				<span>Loading...</span>
			</div>
			<div id = "openPackageButton" type = "button">
				<div class = "blockInButton">
					<img src="images/open_icon.svg">
					<span>Open Package</span>
				</div>
			</div>
			<div id = "backButton" type = "button">
				<div class = "blockInButton">
					<img src="images/Vector4.svg">
					<span>Back</span>
				</div>
			</div>
			<div id = "prepareButton" type = "button">
				<div class = "blockInButton">
					<img src="images/prepare_icon.png">
					<span>Prepare</span>
				</div>
			</div>
			<div class="post_info" id="injector_info">
				<span class="post_header">Injection<br>Syringe</span>
				<img src="images/message_ing.svg"><span></span></img>
			</div>
			<div class="post_info" id="needle_info">
				<span class="post_header">Needle</span>
				<img src="images/message_needle.svg"><span></span></img>
			</div>
		</div>

		<script type = "module">

			import { OrbitControls } from './three/examples/jsm/controls/OrbitControls.js';
			//import { TransformControls } from './three/examples/jsm/controls/TransformControls.js'
        	import { FBXLoader } from './three/examples/jsm/loaders/FBXLoader.js';
			import {GLTFLoader} from './three/examples/jsm/loaders/GLTFLoader.js';
			import { TWEEN } from './three/examples/jsm/libs/tween.module.min.js';
			import { Reflector } from './three/examples/jsm/objects/Reflector.js';
			import { CSS2DRenderer, CSS2DObject } from './three/examples/jsm/renderers/CSS2DRenderer.js';
			import { Refractor } from './three/examples/jsm/objects/Refractor.js';
			import { WaterRefractionShader } from './three/examples/jsm/shaders/WaterRefractionShader.js';

			// scene field

            let scene, renderer, camera, orbitcontrol;
			let refractor;
			let cameraBasePosition;
			let cameraTargetPosition;
			//let transformControls;

			// model field

			let model, mainmodel, ingectionSyringeModel, needle1Model, 
				needle2Model, box, form, manual, formcup, 
				plangerCap, needleCase, needleCap, selectedObject, armatur;
			let basePos, baseRot, baseBoxPos;
			const cubeRenderTarget = new THREE.WebGLCubeRenderTarget(2048)
			const cubeCamera = new THREE.CubeCamera(0.1, 100, cubeRenderTarget)
			const glassMaterial = new THREE.MeshPhysicalMaterial({
				metalness: 0.5,
				roughness: 0.2,
				envMap: cubeRenderTarget.texture,
				refractionRatio: 0.95,
				transparent: true,
				opacity: 0.4,
				transmission: 0.1,
				side: THREE.FrontSide,
				clearcoat: 1.0,
				clearcoatRoughness: 0.39
			});

			const formMaterial = new THREE.MeshPhysicalMaterial({
				metalness: 1.0,
				roughness: 0.2,
				envMap: cubeRenderTarget.texture,
				refractionRatio: 0.95,
				transparent: true,
				opacity: 0.2,
				transmission: 0.1,
				side: THREE.FrontSide,
				clearcoat: 1.0,
				clearcoatRoughness: 0.39
			});

			// animation field

			let skeleton, mixer, clock;
			let scene_action;
			let isOpenPackageAnimate = false, isPrepareAnimate = false, isAnimate = false;
			let timer_delta;
			let isTime = false;
			let tempTime;
			let timedelta = 0;
			let isRebase = false;
			let openPackageAnimationTime = 8.2;
			let prepareAnimationTime = 2.499;
			let isBoxAnimation = false;

			// ui

			let progressBar;

			// app field

			let isLoader = true;
			const container = document.querySelector( '.container' );
			let width = window.innerWidth;
			let height = window.innerHeight;
			var mesh = [];
			let stepindeex = 0;
			let mouse = {
				'position' : {'x' : 0, 'y' : 0},
				'speed' : {'x' : 0, 'y' : 0}
			};
			let my_touch = {
				'start_position' : {'x' : 0, 'y' : 0},
				'position' : {'x' : 0, 'y' : 0}
			}
			let isMouseDown = false;



			init();
			


			function init() {

				progressBar = document.getElementById("progress");

				createScene();		
				scene.add(cubeCamera)
				const gltfLoader = new GLTFLoader();
				const fbxLoader = new FBXLoader()
				model = fbxLoader.load(
					'models/Restylane4.fbx',
					(root) => {
						root.scale.set(60, 60, 60)
						scene.add(root);
						mainmodel = root;
						console.log(dumpObject(root).join('\n'));
						skeleton = new THREE.SkeletonHelper( root );
						skeleton.visible = false;
						scene.add( skeleton );

						const clips = root.animations;
						console.log(clips);
						mixer = new THREE.AnimationMixer( root );

						scene_action = mixer.clipAction(clips[0]);

						root.traverse(function(child){
							mesh.push(child);
							if (child.name == "Box" && !box)
							{
								box = child;
							}
							if (child.name == "Armature")
							{
								armatur = child;
								baseBoxPos = new THREE.Vector3();
								baseBoxPos.x = child.position.x;
								baseBoxPos.y = child.position.y;
								baseBoxPos.z = child.position.z;
							}

							if (child.name == "Injector_t")
							{
								ingectionSyringeModel = child;
							}
							if (child.name == "Needle2_t")
							{
								needle2Model = child;
							}
							if (child.name == "Needle_t")
							{
								needle1Model = child;
							}

							if (child.isMesh){

								if (child.name == "Form")
								{
									form = child;
									child.material = formMaterial;
									//child.visible = false;
								}
								if (child.name == "manual")
								{
									manual = child;
								}

								if (child.name == "FormCap")
								{
									formcup = child;
								}
								if (child.name == "plungerCap")
								{
									plangerCap = child;
								}
								
								if (child.name == "NeedleCase")
								{
									needleCase = child;
								}

								if (child.name == "NeedleCap")
								{
									needleCap = child;
								}

								if (child.name == "InjectorGlass" || child.name == "NeedleCap" || child.name == "NeedleCase" || child.name == "NeedleCase2Glass")
								{
									child.material = glassMaterial;

									const annotationDiv = document.createElement('div');
									annotationDiv.className = 'annotationLabel';
									annotationDiv.innerHTML = '25';
									const annotationLabel = new CSS2DObject(annotationDiv);
									annotationLabel.position.copy(child.position);
									root.add(annotationLabel);

										const annotationTextDiv = document.createElement('div');
										annotationTextDiv.className = 'annotationDescription';
										annotationTextDiv.innerHTML = 'child.userData.title';

											annotationTextDiv.innerHTML += '<p>' + 'test' + '</p>';
										
										annotationDiv.appendChild(annotationTextDiv);	
								}
							}
						});

						cameraBasePosition.x=camera.position.x;
						cameraBasePosition.y=camera.position.y;
						cameraBasePosition.z=camera.position.z;
						

						update();
					},
					(xhr) => {
						console.log((xhr.loaded / xhr.total) * 100 + '% loaded')
						progressBar.style.width = ((xhr.loaded / xhr.total) * 90)  + "%";
					},
					(error) => {
						console.log(error)
					}
				);

				window.addEventListener('resize', onWindowResize, false)
				
				function onWindowResize() {
					camera.aspect = window.innerWidth / window.innerHeight;
					camera.updateProjectionMatrix();

					renderer.setSize(window.innerWidth, window.innerHeight)
				}

				function update()
				{
					mixer.update(clock.getDelta());
					requestAnimationFrame(update)
				}

				function animate() {
					//model.rotation.y += 0.1;
					if (isLoader&&box)
					{
						if (box.material.map.image != null)
						{
							isLoader = false;
							progressBar.style.width = 100 + "%";
							console.log("switch");
							document.getElementById('loaderPage').style.display = "none";
							document.getElementById('openPackageButton').style.display = "block";
						}

					}

					requestAnimationFrame(animate)
					orbitcontrol.update();
					TWEEN.update()
					renderer.render(scene, camera)


				}
				animate();

			}

			// created base configurations for scene
			function createScene()
			{
				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.position.set( -20, 4, - 25 );
				camera.lookAt( 0, 1, 0 );
				cameraBasePosition = new THREE.Vector3();
				cameraTargetPosition = new THREE.Vector3(3, 8, -25);

				document.addEventListener('mousedown', onDocumentMouseDown, false);

				clock = new THREE.Clock();

				scene = new THREE.Scene();
				scene.background = new THREE.Color("rgb(133,202,237)");
				scene.fog = new THREE.Fog("rgb(133,202,237)", 20, 80 );

				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.shadowMap.enabled = true;
				container.appendChild( renderer.domElement );

				//OrbitControls
				orbitcontrol = new OrbitControls(camera, renderer.domElement);
				orbitcontrol.update();
				orbitcontrol.maxPolarAngle = Math.PI / 2.5;
				//orbitcontrol.minPolarAngle = Math.PI / 3;
				orbitcontrol.enablePan = false;
				orbitcontrol.dampingFactor = 0.1;
				orbitcontrol.enableDamping = true;
				orbitcontrol.minDistance = 20;
				orbitcontrol.maxDistance = 55;
				orbitcontrol.autoRotate = true;
				orbitcontrol.autoRotateSpeed = 0.5;

				const color = 0xFFFFFF;
				const intensity = 1;
				const light = new THREE.AmbientLight(color, intensity);
				scene.add(light);

				//const hemiLight = new THREE.HemisphereLight( 0xB1E1FF, 0xffffff, 1.5 );
				//hemiLight.position.set( 0, 20, 0 );
				//scene.add( hemiLight );
				const dirLight = new THREE.DirectionalLight( 0xffffff, 1.5);
				dirLight.position.set( - 3, 10, - 10 );
				//dirLight.target.position.set(0, 0, 0);
				dirLight.castShadow = true;
				dirLight.shadow.camera.top = 2;
				dirLight.shadow.camera.bottom = - 2;
				dirLight.shadow.camera.left = - 2;
				dirLight.shadow.camera.right = 2;
				dirLight.shadow.camera.near = 0.1;
				dirLight.shadow.camera.far = 40;
				scene.add( dirLight );

				//const helper = new THREE.DirectionalLightHelper(dirLight);
				//scene.add(helper);

				// ground
				const mesh = new THREE.Mesh( new THREE.PlaneGeometry( 2000, 2000 ), new THREE.MeshPhongMaterial( { color: 0x999999, depthWrite: false } ) );
				mesh.rotation.x = - Math.PI / 2;
				mesh.position.y = -20;
				mesh.receiveShadow = true;
				scene.add( mesh );

				const refractorGeometry = new THREE.PlaneGeometry( 2000, 2000 );

				refractor = new Refractor( refractorGeometry, {
					color: 0x999999,
					textureWidth: 100,
					textureHeight: 100,
					shader: WaterRefractionShader
				} );
				refractor.position.set( 0, 0, -1 );
				refractor.rotation.set(0, - Math.PI , 0);
				//scene.add( refractor );
				//refractor.visible = false;
			}

			// write object structer to console
			function dumpObject(obj, lines = [], isLast = true, prefix = '') {
					const localPrefix = isLast ? '└─' : '├─';
					lines.push(`${prefix}${prefix ? localPrefix : ''}${obj.name || '*no-name*'} [${obj.type}]`);
					const newPrefix = prefix + (isLast ? '  ' : '│ ');
					const lastNdx = obj.children.length - 1;
					obj.children.forEach((child, ndx) => {
						const isLast = ndx === lastNdx;
						dumpObject(child, lines, isLast, newPrefix);
					});
					return lines;
			}

			function startOpenPackageAnimation()
			{
				timer_delta = openPackageAnimationTime;

				scene_action.reset()
				scene_action.timeScale = 1;
				scene_action.setLoop(THREE.LoopOnce);
				scene_action.clampWhenFinished = true;

				scene_action.play();
				isAnimate = true;
				isOpenPackageAnimate = true;

			}
			
			function endOpenPackageAnimation()
			{
				startSecondStep();
				setMainDefaultPosition(cameraTargetPosition);
			}

			function reversOpenPackageAnimation()
			{
				timer_delta = openPackageAnimationTime;//6.6 + 1.6;

				scene_action.time = openPackageAnimationTime;
				scene_action.paused = false;
				scene_action.timeScale = -1;
				scene_action.setLoop(THREE.LoopOnce);  



				isAnimate = true;
				isOpenPackageAnimate = true;
				isRebase = true;

				manual.visible = false;
				formcup.visible = false;
				box.visible = false;
				form.visible = false;
			}

			function startPrepareAnimation()
			{
				timer_delta = prepareAnimationTime;

				//scene_action.reset()
				scene_action.time = openPackageAnimationTime;
				scene_action.timeScale = 1;
				scene_action.setLoop(THREE.LoopOnce);
				scene_action.clampWhenFinished = true;
				

				scene_action.paused = false;

				needle2Model.visible = false;
				plangerCap.visible = false;
				needleCase.visible = false;
				needleCap.visible = false;

				isAnimate = true;
				isPrepareAnimate = true;

				document.getElementById("prepareButton").style.display = "none";
				document.getElementById("backButton").style.display = "none";
			}

			function reversPrepareAnimation()
			{
				timer_delta = prepareAnimationTime;

				scene_action.paused = false;
				scene_action.timeScale = -1;
				scene_action.setLoop(THREE.LoopOnce); 

				isAnimate = true;
				isPrepareAnimate = true;

				scene_action.paused=false;

				//document.getElementById("prepareButton").style.display = "none";
				document.getElementById("backButton").style.display = "none";
			}

			function endReversPrepareAnimation()
			{
				needle2Model.visible = true;
				plangerCap.visible = true;
				needleCase.visible = true;
				needleCap.visible = true;

				isRebase = false;

				startSecondStep();
			}

			function endPrepareAnimation()
			{
				document.getElementById("backButton").style.display = "block";
				stepindeex = 2;
				orbitcontrol.enabled = true;
				orbitcontrol.autoRotate = true;
			}

			function startSecondStep()
			{
				document.getElementById("backButton").style.display = "block";
				document.getElementById("prepareButton").style.display = "block";
				stepindeex = 1;
			}


			function resizeRendererToDisplaySize(renderer) {
				const canvas = renderer.domElement;
				const width = canvas.clientWidth;
				const height = canvas.clientHeight;
				const needResize = canvas.width !== width || canvas.height !== height;
				if (needResize) {
				renderer.setSize(width, height, false);
				}
				return needResize;
			}



			function render(time) {
				time *= 0.001;  // convert to seconds
				//console.log(orbitcontrol.object.rotation);
				//console.log(orbitcontrol.spherical.theta);

				if (isAnimate && !isTime)
				{
					isTime = true;
					tempTime = time;
					//console.log("start", time, " ", timer_delta);
				}

				if (isTime)
				{
					timedelta = (time) - tempTime;
				}
				//timedelta = (time)- tempTime;

				if (isAnimate&&isOpenPackageAnimate)
				{
					if (isRebase)
					{
						
						//console.log(timedelta);
						if (timedelta > 1.5 && !formcup.visible)
						{
							//box.visible = true;
							form.visible = true;
							manual.visible = true
							formcup.visible = true;
						}

						if (timedelta > (timer_delta - 4.0) && !isBoxAnimation)
						{
							console.log("isBox");
							isBoxAnimation = true;
							box.visible = true;
							//scene_action.paused = true;
							const newBoxVector = new THREE.Vector3(0.5,0,0);
							console.log(armatur.position);
							animateVector3(armatur.position, baseBoxPos, {
								duration: 2000, 
								//easing : TWEEN.Easing.Quadratic.InOut,
								update: function(d) {
									console.log("Updating: " + d);
								},
								callback : function(){
									console.log("Completed", armatur.position, timedelta);
									
									//transformControls.attach(selectedObject);
									//transformControls.enabled = true;
									//transformControls.visible = true;

								}
							});
						}

						if (timedelta > timer_delta)
						{
							isAnimate = false;
							isTime = false;
							isOpenPackageAnimate = false;
							isRebase = false;
							isBoxAnimation = false;
							scene_action.paused = true;
							orbitcontrol.enabled = true;
							orbitcontrol.autoRotate = true;
							
							document.getElementById("openPackageButton").style.display = "block";
						}
					}
					else
					{
						//console.log(timedelta)
						if (timedelta > 2.0 && !isBoxAnimation)
						{
							console.log("isBox");
							isBoxAnimation = true;
							//scene_action.paused = true;
							const newBoxVector = new THREE.Vector3(0.5,0,0);
							console.log(armatur.position);
							animateVector3(armatur.position, newBoxVector, {
								duration: 2000, 
								//easing : TWEEN.Easing.Quadratic.InOut,
								update: function(d) {
									console.log("Updating: " + d);
								},
								callback : function(){
									console.log("Completed", armatur.position, timedelta);
									box.visible = false;
									//transformControls.attach(selectedObject);
									//transformControls.enabled = true;
									//transformControls.visible = true;

								}
							});

						}
						if (timedelta > 3.6 && formcup.visible)
						{
							form.visible = false;
							formcup.visible = false;
						}

						if (timedelta > 6.625 && manual.visible)
						{
							//box.visible = false;
							manual.visible = false;
							if (box.visible)
							{
								console.log("is true");
							}
						}

						if (timedelta > timer_delta)
						{
							isAnimate = false;
							isTime = false;
							isOpenPackageAnimate = false;
							isBoxAnimation = false;

							scene_action.paused = true;

							endOpenPackageAnimation();
						}
					}
				}

				if (isAnimate&&isPrepareAnimate)
				{
					//console.log(timedelta)
					if (isRebase)
					{
						/*if (timedelta > 0.89 && !isPrepareInjectorAnimate)
						{
							isPrepareInjectorAnimate = true;
							prepareinjector_action.play();
							console.log("start moov injectro")
						}*/
						if (timedelta > timer_delta)
						{
							isAnimate = false;
							isTime = false;
							isPrepareAnimate = false;

							scene_action.paused = true;

							endReversPrepareAnimation();
						}
					}
					else{

						/*if (timedelta > 1.6 && isPrepareInjectorAnimate)
						{
							isPrepareInjectorAnimate = false;
							prepareinjector_action.paused = true;
							console.log("end moov injectro")
						}*/
						if (timedelta > timer_delta)
						{
							isAnimate = false;
							isTime = false;
							isPrepareAnimate = false;

							scene_action.paused = true;

							endPrepareAnimation();
						}
					}

				}

	
				renderer.render(scene, camera);
				
				requestAnimationFrame(render);
			}
			requestAnimationFrame(render);

			function setMainDefaultPosition(pos, completeCallback)
			{
				//orbitcontrol.enabled = true;
				//orbitcontrol.reset();
				/*orbitcontrol.resetCamera = function ( ) {
					orbitcontrol.object.position.x= pos.xPosition;
					orbitcontrol.object.position.y = pos.yPosition;
					orbitcontrol.object.position.z = pos.zPosition;
				};*/
				/*camera.position.x = pos.x;
				camera.position.y = pos.y;
				camera.position.z = pos.z;
				if(completeCallback) completeCallback();*/
				//var tween2 = TWEEN.Tween(camera.position).to({x: pos.x, y: pos.y, z: pos.z,}, 500);
				
				var tween2 = new TWEEN.Tween(camera.position)
					.to({ x: pos.x, y: pos.y, z: pos.z, }, 500)
					/*.easing(easing)
					.onUpdate(function(d) {
						if(options.update){ 
							options.update(d);
						}
					})*/
					.onComplete(function(){
					if(completeCallback) completeCallback();
					});
				tween2.start();
				/*console.log(orbitcontrol.object.rotation);	
				animateVector3(camera.position, pos, {
					duration: 1000, 
					//easing : TWEEN.Easing.Quadratic.InOut,
					update: function(d) {
						console.log("Updating: " + d);
					},
					callback : function(){
						console.log("Completed",camera.position);
						if(completeCallback) completeCallback();
						console.log(orbitcontrol.object.rotation);
						/*document.getElementById("backButton").style.display = "block";
						if (stepindeex=='3') {
							document.getElementById("injector_info").style.display = "block";
						}
						else {
							document.getElementById("needle_info").style.display = "block";
						}*/
						//transformControls.attach(selectedObject);
						//transformControls.enabled = true;
						//transformControls.visible = true;

				/*}
				});*/
				//mainmodel.rotation.set(0,0,0);
				//mainmodel.position.set(0,0,0);
			}

			function InitUIClick()
			{
				let obj = document.getElementById("openPackageButton");
				let backButton = document.getElementById("backButton");
				let prepareButton = document.getElementById("prepareButton");

				obj.onclick = function(){
					console.log(orbitcontrol.rotation);
					console.log(orbitcontrol.rotation);
					orbitcontrol.enabled = false;
					orbitcontrol.autoRotate = false;
					obj.style.display = "none";
					setMainDefaultPosition(cameraBasePosition, startOpenPackageAnimation);
					//camera.position.set( -7, 4, - 5 );
					
					
					obj.style.display = "none";
					//backButton.style.display = "block";
				}

				backButton.onclick = function(){
					console.log(camera.position);
					
					orbitcontrol.enabled = false;
					orbitcontrol.autoRotate = false;
					if (stepindeex == '2')
					{
						isRebase = true;
						setMainDefaultPosition(cameraTargetPosition, reversPrepareAnimation);
					}
					if (stepindeex == '1')
					{
						isRebase = true;
						backButton.style.display = "none";
						prepareButton.style.display = "none";
						setMainDefaultPosition(cameraBasePosition, reversOpenPackageAnimation);
						//camera.position.set( -7, 4, - 5 );
						stepindeex = 0;
					}
					if (stepindeex == '3' || stepindeex == '4' || stepindeex == '5')
					{
						backButton.style.display = "none";
						document.getElementById("needle_info").style.display = "none";
						document.getElementById("injector_info").style.display = "none";
				

						//transformControls.enabled = false;
						//transformControls.visible = false;
						selectedObject.rotation.x = baseRot.x;
						selectedObject.rotation.y = baseRot.y;
						selectedObject.rotation.z = baseRot.z;
						orbitcontrol.enabled = false;
						orbitcontrol.autoRotate = false;
						setMainDefaultPosition(cameraTargetPosition, function() {
							animateVector3(selectedObject.position, basePos, {
								duration: 500, 
								//easing : TWEEN.Easing.Quadratic.InOut,
								update: function(d) {
									console.log("Updating: " + d);
								},
								callback : function(){
									console.log("Completed");
									//refractor.visible = false;
									orbitcontrol.enabled = false;
									orbitcontrol.autoRotate = false;
									needle1Model.visible = true;
									needle2Model.visible = true;	
									ingectionSyringeModel.visible = true;
									startSecondStep();
								}
							});
						});

					}
				}
				prepareButton.onclick = function(){
					startPrepareAnimation();
				}


			}


			document.addEventListener('click', onDocumentMouseDown, false);
	
			function onDocumentMouseDown(event) {
				// Click on the screen to create a vector
				var vector = new THREE.Vector3((event.clientX / window.innerWidth) * 2 - 1, -(event.clientY / window
					.innerHeight) * 2 + 1, 0.5);
					vector = vector.unproject (camera); // convert the coordinates of the screen into the coordinate of the three-dimensional scene
				var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());
				var intersects = raycaster.intersectObjects(mesh, true);

				if (stepindeex == '1')
				{
					if (intersects.length > 0) {
						//intersects[0].object.material.color.set("#ff0000");
						intersects.forEach(element => {
							//console.log(element.object.name);
							if ((element.object.name == "Injector" ||
							element.object.name == "InjectorGlass" ||
							element.object.name == "plungerCap" ||
							element.object.name == "InjectorPlunger")
							&&stepindeex=='1')
							{
								//console.log("injector");
								stepindeex = 3;
								needle1Model.visible = false;
								needle2Model.visible = false;
								mooveSelectedObjAction(ingectionSyringeModel, function(){
									orbitcontrol.enabled = true;
									orbitcontrol.autoRotate = true;
								});
								return;
							}
							if ((element.object.name == "Needle" ||
							element.object.name == "NeedleCase" ||
							element.object.name == "NeedleCap")
							&&stepindeex=='1')
							{
								//console.log("needle1");
								stepindeex = 4;
								ingectionSyringeModel.visible = false;
								needle2Model.visible = false;
								mooveSelectedObjAction(needle1Model, function(){
									orbitcontrol.enabled = true;
									orbitcontrol.autoRotate = true;
								});
								return;
							}
							if ((element.object.name == "NeedleCase2" ||
							element.object.name == "NeedleCase2Glass")
							&&stepindeex=='1')
							{
								//console.log("needle2");
								stepindeex = 5;
								ingectionSyringeModel.visible = false;
								needle1Model.visible = false;
								mooveSelectedObjAction(needle2Model, function(){
									orbitcontrol.enabled = true;
									orbitcontrol.autoRotate = true;
								});
								return;
							}	
						});
					}
				}	
			}

			function mooveSelectedObjAction(obj, Objcallback)
			{
				document.getElementById("prepareButton").style.display = "none";
				document.getElementById("backButton").style.display = "none";

				//refractor.visible = true;
				//console.log(obj.rotation);
				var target = (stepindeex=='5')?(new THREE.Vector3(0, 0, 0)):(new THREE.Vector3(0, 0, 0));
				//console.log(obj.position);
				basePos = new THREE.Vector3();
				basePos.x = obj.position.x;
				basePos.y = obj.position.y;
				basePos.z = obj.position.z;
				baseRot = new THREE.Vector3();
				baseRot.x = obj.rotation.x;
				baseRot.y = obj.rotation.y;
				baseRot.z = obj.rotation.z;
				selectedObject = obj;
				animateVector3(selectedObject.position, target, {
					duration: 1000, 
					//easing : TWEEN.Easing.Quadratic.InOut,
					update: function(d) {
						//console.log("Updating: " + d);
					},
					callback : function(){
						//console.log("Completed");
						document.getElementById("backButton").style.display = "block";
						if (stepindeex=='3') {
							document.getElementById("injector_info").style.display = "block";
						}
						else {
							document.getElementById("needle_info").style.display = "block";
						}

						if (Objcallback) Objcallback();
						//transformControls.attach(selectedObject);
						//transformControls.enabled = true;
						//transformControls.visible = true;

					}
				});
			}
			function animateVector3(vectorToAnimate, target, options){
				//console.log(vectorToAnimate, " to ", target);
				options = options || {};
				// get targets from options or set to defaults
				var to = target || THREE.Vector3(),
					easing = options.easing || TWEEN.Easing.Quadratic.In,
					duration = /*options.duration ||*/ 2000;
				// create the tween
				var tweenVector3 = new TWEEN.Tween(vectorToAnimate)
					.to({ x: to.x, y: to.y, z: to.z, }, duration)
					/*.easing(easing)
					.onUpdate(function(d) {
						if(options.update){ 
							options.update(d);
						}
					})*/
					.onComplete(function(){
					if(options.callback) options.callback();
					});
				// start the tween
				tweenVector3.start();
				// return the tween in case we want to manipulate it later on
				return tweenVector3;
			}
			InitUIClick();
			
        </script>
    </body>
</html>